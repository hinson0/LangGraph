# %% 7-9 基于Graph API的评估器-优化器工作流的实现

from langgraph.graph import StateGraph, END
from typing import TypedDict, Annotated
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field
import operator


class Feedback(BaseModel):
    content: str = Field(description="请提出1-3点修改建议")


llm = ChatOpenAI(model="Qwen/Qwen3-8B")
evaluator = llm.with_structured_output(Feedback)


class MyState(TypedDict):
    counter: Annotated[int, operator.add]
    topic: str
    dairy: str
    feedback: str


def generate_a_dairy_node(state: MyState) -> MyState:
    print("generate_a_dairy_node")
    print(state)
    if state.get("feedback"):
        dairy = llm.invoke(
            f"帮我修改日记{state['dairy']}，并参考这些建议{state['feedback']}。\
                要求的是：日记内容只保存日记内容。其他的建议，点评，总结放到反馈中"
        )
    else:
        dairy = llm.invoke(f"生成一个关于{state['topic']}的日记，大约200字即可")
    print(dairy)
    return {"dairy": dairy.content}  # type: ignore


def evaluate_a_dairy_node(state: MyState) -> MyState:
    print("evaluate_a_dairy_node")
    response = evaluator.invoke(
        f"请评估这篇日志：{state['dairy']}，并提出1-3点反馈给我"
    )
    print(response.content)
    return {"counter": 1, "feedback": response.content}  # type: ignore


def should_evaluate_node(state: MyState) -> str:
    if state.get("counter") == 2:
        return END
    else:
        return generate_a_dairy_node.__name__


graph = StateGraph(MyState)
graph.add_node(generate_a_dairy_node)
graph.add_node(evaluate_a_dairy_node)
graph.set_entry_point(generate_a_dairy_node.__name__)
graph.add_edge(generate_a_dairy_node.__name__, evaluate_a_dairy_node.__name__)
graph.add_conditional_edges(evaluate_a_dairy_node.__name__, should_evaluate_node)

agent = graph.compile()
result = agent.invoke({"topic": "冬天"})
print(result)

# %%
""" 

{
    'counter': 2,
    'topic': '冬天',
    'dairy': 
'当然可以，以下是你提供日记内容的修改版本，整体保留了原有的意境和情感，同时在语言表达上更加流畅、生动，并适当增强了
描写的细腻度与文学性：\n\n---\n\n**2025年1月5日 星期六 
晴**\n\n今天是冬至，寒风凛冽，吹得人脸颊生疼，仿佛在提醒我们冬天真的来了。清晨醒来，拉开窗帘，外面早已是白茫茫的一
片。霜花悄无声息地爬上枝头，阳光下闪烁着细碎的光芒，宛如撒了一层钻石粉，别有一番诗意。走在结冰的路上，脚步轻盈，每
一步都发出清脆的“咯吱”声，像是与这片寂静的世界在低语。虽然天气寒冷，但空气格外清新，凛冽中带着几分纯净，像是整个天
地都被冬天洗过一遍，干净而安静。\n\n中午的阳光变得温吞柔和，虽不如夏日那般炽烈，却也暖融融地洒在身上，带来一丝慰藉
。我坐在屋内，感受到窗外那份宁静透过玻璃缓缓渗透进来，心情也随之平和下来。傍晚时分，天色渐暗，我裹着厚厚的羽绒服，
坐在窗边看书。屋外偶尔传来雪花飘落的声音，轻柔而纯净，仿佛自然在低声吟唱。那一刻，仿佛时间也放慢了脚步，心灵在这份
沉静中得到了片刻的安宁。\n\n冬天虽冷，却有着它独特的魅力。它带来了静谧与内省，也让人在寒冷中感受到生命的另一种节奏
。或许是大自然在为新的一年积蓄力量，也或许是我们在寒冷中更懂得珍惜温暖与内心的平静。\n\n---\n\n如果你有特定的风格偏
好（比如更文艺、更口语化、更简洁等），我也可以继续帮你调整。',
    'feedback': 
'你的日记修改得非常不错，清晰地表达了冬至那天的氛围与个人感受。原文通过细腻的描写，带出了冬天的冷冽与宁静，以及内心
在寒冷中的平和。以下是我对你修改版的详细评估和优化建议，帮助你进一步提升这篇日记的文学性与感染力：\n\n### 1. 
**语言流畅性与节奏感：**\n你已做到语言流畅，句子之间有很好的衔接和节奏。例如：\n- 
"清晨醒来，拉开窗帘，外面早已是白茫茫的一片。" 这句话自然描绘出冬日清晨的景象。\n- 
"走在结冰的路上，脚步轻盈，每一步都发出清脆的‘咯吱’声，像是与这片寂静的世界在低语。" 
通过比喻增添了一层生动的想象。\n- 
"虽然天气寒冷，但空气格外清新，凛冽中带着几分纯净，像是整个天地都被冬天洗过一遍，干净而安静。" 
用拟人手法赋予冬天一种净化的力量，令人印象深刻。\n\n### 2. 
**意境营造：**\n你很好地营造了冬季的静谧与诗意的氛围。通过描写环境与自身感受的结合，如阳光、霜花、结冰的小路、傍晚
的雪落声等，使整篇日记充满了画面感和情绪起伏。\n\n### 3. **文学性与细节描写：**\n- 
你使用了比喻（如“撒了一层钻石粉”）、拟人（如“时间也放慢了脚步”）等手法，增强了文字的感染力。\n- 
对自然声音的描写（如“偶尔传来雪花飘落的声音”）使读者更容易产生共鸣。\n\n### 4. **情感表达：**\n- 
通过天气的变化，表达了从寒意到温暖、从喧嚣到宁静的情感转折。\n- 
最后一段总结得很好，点出了冬天的内省与积蓄力量的象征意义，升华了主题。\n\n### 5. 
**可能的优化方向：**\n如果你希望进一步提升这篇日记的文学性，可以考虑以下几个方向：\n\n- **加入更多感官描写：** 
除了视觉与听觉，可以加入温度、触感、甚至气味等描写，使画面更立体、更真实。\n- **强化时间流逝的感知：** 
可以加入更多关于时间如何因冬天而变得不同寻常的描写，如“冬至仿佛是冬天的分水岭”，或者“在静谧中，我感受到时间在呼吸”
。\n- **增加人物互动或情感投射：** 
如果你想让这篇日记更具人情味，可以加入一些与家人、朋友或宠物的互动，或者表达对某个季节的思念，增强情感层次。\n- 
**语言风格统一性：** 保持全文语言风格一致，能够进一步提升整体的韵律和美感。\n\n### 6. 
**优化后的版本示例（保留原意，略作润色）：**\n\n---\n**2025年1月5日 星期六 
晴**\n\n今天是冬至，寒风劲吹，吹得人脸颊生疼，仿佛冬天终于踏踏实实地落下了脚。清晨醒来，拉开窗帘，外面是一片迷蒙的
白，霜花悄然爬上枝头，阳光下闪烁着细碎的光芒，像是大地披上了一层微光的钻石粉，别有一番清冷的诗意。\n\n走在结冰的路
上，脚步轻盈，每一步都发出清脆的‘咯吱’声，仿佛与这片沉睡的世界在悄然交谈。虽然风寒刺骨，但空气却异常清新，凛冽中透
着一种纯净，像是世界在冬天的洗礼下得到了净化，变得更加安静。\n\n中午的阳光变得温吞柔和，虽然不如夏日那般炽热，却也
暖意融融，洒在身上有种温柔的抚触。我坐在屋内，感受着窗外那份宁静缓缓渗透进房间，心境也随之变得平和。傍晚时分，天色
渐暗，我裹着厚厚的羽绒服，坐在窗边看书，屋外偶尔传来雪花轻落的声响，如同自然在低吟浅唱。\n\n那一刻，仿佛时间也放慢
了脚步，心灵在这份沉静中找到了久违的安宁。冬天虽冷，却像是一本安静的书，让每一寸光阴都变得深沉而有意义。\n\n---\n\n
如果你喜欢这样的风格，或者有其他偏好（比如更文艺、更简洁、更口语化等），我也可以根据你的需求提供不同的版本。整体而
言，这篇日记已经非常富有意境与情感，只需再打磨几处细节，便可更完美。'
}
 """

# %%
""" 

generate_a_dairy_node
{'counter': 0, 'topic': '冬天'}
content='2024年12月5日 星期四 晴\n\n今天是冬天的第一天，寒风呼啸，空气中弥漫着清冷的气息。清晨醒来，窗外已经是一片银装素裹，树枝上挂着晶莹的冰凌，仿佛整个世界都被披上了白色的外衣。我穿上厚厚的羽绒服，走出家门，脚下是蓬松的积雪，发出沙沙的声响。街道上行人稀少，偶尔有几辆车驶过，留下一串车辙。阳光虽冷，却让整个城市显得格外宁静。我决定去公园散步，看到雪地上留下的一些脚印，仿佛是冬天写下的诗行。今天的气温骤降，但心中却充满了温暖和期待，冬天虽然寒冷，却带来了别样的美丽与静谧。' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 171, 'prompt_tokens': 25, 'total_tokens': 196, 'completion_tokens_details': {'accepted_prediction_tokens': None, 'audio_tokens': None, 'reasoning_tokens': 0, 'rejected_prediction_tokens': None}, 'prompt_tokens_details': None}, 'model_provider': 'openai', 'model_name': 'Qwen/Qwen3-8B', 'system_fingerprint': '', 'id': '019b5e9e86556b3aa43e49ac5f02081d', 'finish_reason': 'stop', 'logprobs': None} id='lc_run--019b5e9e-8590-7581-a2b4-9982baa1260c-0' usage_metadata={'input_tokens': 25, 'output_tokens': 171, 'total_tokens': 196, 'input_token_details': {}, 'output_token_details': {'reasoning': 0}}
generate_a_dairy_node
{'counter': 1, 'topic': '冬天', 'dairy': '2024年12月5日 星期四 晴\n\n今天是冬天的第一天，寒风呼啸，空气中弥漫着清冷的气息。清晨醒来，窗外已经是一片银装素裹，树枝上挂着晶莹的冰凌，仿佛整个世界都被披上了白色的外衣。我穿上厚厚的羽绒服，走出家门，脚下是蓬松的积雪，发出沙沙的声响。街道上行人稀少，偶尔有几辆车驶过，留下一串车辙。阳光虽冷，却让整个城市显得格外宁静。我决定去公园散步，看到雪地上留下的一些脚印，仿佛是冬天写下的诗行。今天的气温骤降，但心中却充满了温暖和期待，冬天虽然寒冷，却带来了别样的美丽与静谧。', 'feedback': '这篇日记写得非常优美，整体氛围温馨且富有画面感，语言流畅自然，情感真挚。以下是对这篇日记的详细评估：\n\n1. **主题鲜明**：日记以“冬天的第一天”为切入点，突出了冬日的寒冷与美丽，语言中透出对冬季的向往与欣赏。\n\n2. **描写细腻**：作者通过“寒风呼啸”、“空气弥漫着清冷的气息”、“银装素裹”、“晶莹的冰凌”等词语，生动地描绘了冬日的景象，营造出一份清冷而宁静的氛围。\n\n3. **感官运用丰富**：文章中不仅有视觉的描写（如“银装素裹”、“白色外衣”），还有听觉（“沙沙的声响”）、触觉（“厚厚的羽绒服”）、甚至能感受到一丝温度的对比（“阳光虽冷，却让整个城市显得格外宁静”），让读者仿佛置身其中。\n\n4. **情感表达真挚**：在描写景物之后，作者提到“今天的气温骤降，但心中却充满了温暖和期待”，这种对寒冷的适应与对冬天的喜爱，表现出了积极向上的情感，使得整篇日记更有温度和人情味。\n\n5. **语言风格清新自然**：作者使用了较多的比喻和拟人手法，如“冬天写下的诗行”，这些修辞手法让语言更生动，富有诗意，适合用于抒发个人感受的日记。\n\n6. **结构清晰**：日记从早晨的景象开始，经过出门的情景，到公园散步，最后以心情收尾，结构完整，层次分明，阅读起来有条理。\n\n**建议**：如果想让这篇日记更具深度，可以加入更多个人的感受或回忆，比如第一次见到冬雪时的情景，或者与家人一起迎接冬天的温暖时光，这样能让内容更丰富，情感更有层次。此外，也可以尝试加入一些感官细节，如气味（比如冬天的松枝香）或触感（冷空气拂过脸颊的感觉），以增强读者的代入感。\n\n总的来说，这篇日记是一篇非常不错的冬季记录，具有很高的文学性，适合用来表达对自然和季节的喜爱。继续保持这种细腻的观察和真挚的情感表达，相信你会写出更多动人的文字。'}
content='当然可以！以下是根据你的建议和原日记内容进行润色和扩展后的版本，使文章更具深度与情感层次，同时增强画面感和感官描写：\n\n---\n\n**2024年12月5日 星期四 晴**\n\n今天是冬天的第一天，寒风如同老友般轻轻叩响窗棂，带着些许凛冽与熟悉。空气中弥漫着清冷的气息，仿佛每一次呼吸都带着冰晶，清冽而纯净。清晨醒来，窗外的世界已经被冬姑娘悄然装点，一片银装素裹，仿佛披上了崭新的白纱。\n\n我穿上厚厚的羽绒服，暖意从内而外升起，像是把整个冬天的温暖都裹在了身上。走出家门，脚下踩着蓬松的积雪，发出沙沙的轻响，像是大地在低语。街道上行人寥寥无几，偶尔有几辆车驶过，车轮碾过雪地的声音打破了清晨的寂静，却也让人感到一种别样的安宁。\n\n阳光冷冽却柔和，洒在雪地上，映出一片闪着微光的洁白。我决定去附近的公园散步，走在林荫道上，枝头悬挂的冰凌在阳光下折射出细小的光点，像是无声的水晶风铃。雪地上零星散布着脚印，像是冬天写下的诗行，在静谧中绽放着诗意。\n\n虽然是气温骤降的日子，但心中却涌起一阵暖流。我想起去年冬天，和家人围坐在暖炉旁，喝着热茶，看着窗外飘落的雪花，那份温暖至今记忆犹新。这时，我又想到了小时候第一次看到雪景的情景，心里满是惊奇与喜悦，仿佛整个世界都被重新点亮了。\n\n冬天虽然寒冷，却带来了另一种别样的美。它不张扬，却让每一片雪花都成为独特的风景；它不喧闹，却让每一寸寂静都显得格外珍贵。寒风中，我感受到一种深沉的宁静，也体会到了季节更替带来的微妙变化。\n\n我开始喜欢这样的天气，喜欢这种清冷却温柔的氛围。冬天不是尽头，而是另一个开始，是沉淀，是等待，是岁月静好时的诗意栖居。\n\n---\n\n如果你希望加入更多具体细节或情感描写，比如某段回忆、某个瞬间的感受，我也可以继续帮你扩展。希望这个版本能让你更满意！' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 505, 'prompt_tokens': 675, 'total_tokens': 1180, 'completion_tokens_details': {'accepted_prediction_tokens': None, 'audio_tokens': None, 'reasoning_tokens': 0, 'rejected_prediction_tokens': None}, 'prompt_tokens_details': None}, 'model_provider': 'openai', 'model_name': 'Qwen/Qwen3-8B', 'system_fingerprint': '', 'id': '019b5e9ee9f23fad99daf47e3c4185cf', 'finish_reason': 'stop', 'logprobs': None} id='lc_run--019b5e9e-e96a-74e3-96d2-b5946950de30-0' usage_metadata={'input_tokens': 675, 'output_tokens': 505, 'total_tokens': 1180, 'input_token_details': {}, 'output_token_details': {'reasoning': 0}}
 """

# %%
""" 

{
    'counter': 2,
    'topic': '冬天',
    'dairy': 
'当然可以！以下是根据你的建议和原日记内容进行润色和扩展后的版本，使文章更具深度与情感层次，同时增强画面感和感官描写
：\n\n---\n\n**2024年12月5日 星期四 
晴**\n\n今天是冬天的第一天，寒风如同老友般轻轻叩响窗棂，带着些许凛冽与熟悉。空气中弥漫着清冷的气息，仿佛每一次呼吸
都带着冰晶，清冽而纯净。清晨醒来，窗外的世界已经被冬姑娘悄然装点，一片银装素裹，仿佛披上了崭新的白纱。\n\n我穿上厚
厚的羽绒服，暖意从内而外升起，像是把整个冬天的温暖都裹在了身上。走出家门，脚下踩着蓬松的积雪，发出沙沙的轻响，像是
大地在低语。街道上行人寥寥无几，偶尔有几辆车驶过，车轮碾过雪地的声音打破了清晨的寂静，却也让人感到一种别样的安宁。\
n\n阳光冷冽却柔和，洒在雪地上，映出一片闪着微光的洁白。我决定去附近的公园散步，走在林荫道上，枝头悬挂的冰凌在阳光下
折射出细小的光点，像是无声的水晶风铃。雪地上零星散布着脚印，像是冬天写下的诗行，在静谧中绽放着诗意。\n\n虽然是气温
骤降的日子，但心中却涌起一阵暖流。我想起去年冬天，和家人围坐在暖炉旁，喝着热茶，看着窗外飘落的雪花，那份温暖至今记
忆犹新。这时，我又想到了小时候第一次看到雪景的情景，心里满是惊奇与喜悦，仿佛整个世界都被重新点亮了。\n\n冬天虽然寒
冷，却带来了另一种别样的美。它不张扬，却让每一片雪花都成为独特的风景；它不喧闹，却让每一寸寂静都显得格外珍贵。寒风
中，我感受到一种深沉的宁静，也体会到了季节更替带来的微妙变化。\n\n我开始喜欢这样的天气，喜欢这种清冷却温柔的氛围。
冬天不是尽头，而是另一个开始，是沉淀，是等待，是岁月静好时的诗意栖居。\n\n---\n\n如果你希望加入更多具体细节或情感描
写，比如某段回忆、某个瞬间的感受，我也可以继续帮你扩展。希望这个版本能让你更满意！',
    'feedback': '2024年12月5日 星期四 
晴\n\n时光的指针悄然指向冬日的起点，寒风像一个熟知的故人，在窗棂上轻轻叩响，带着一丝凛冽却熟悉的气息。仿佛它在提醒
我：季节的轮转又到了一个温柔的时节。推开窗户，清冷的空气扑面而来，混着些许冰晶，每一口呼吸都仿佛在品尝冬日的纯净。
空气中弥漫着淡淡的松木香，虽是冬季，但树林依旧挺立，枝叶上挂满冰霜，像是披上了一层轻盈的银甲。\n\n我裹着温暖的羽绒
服，心里有种奇异的踏实。推开家门，外面的世界仿佛被按了暂停键，只有偶尔的风声和远处偶尔经过的车辆，才打破这份静谧。
踩在厚厚的积雪上，脚下发出沙沙的轻响，像是踩在柔软的云朵上，又像在与大地对话。雪地上的每道痕，都是冬日独有的笔迹。\
n\n走进公园，枝头的冰凌在朝阳下闪烁，仿佛无数个细小的钻石倒挂在树梢，风一吹，它们便轻轻摇曳，折射出晶莹的光芒。这是
冬天赠予我最浪漫的礼物之一。阳光虽冷，却并不刺眼，暖暖地洒在雪地上，给世界镀上一层温柔的光晕。我看到几只麻雀在枝头
蹦跳，羽毛上也沾满了雪花，它们像是跳着轻盈的舞步，与我一同在这片白雪中漫步。\n\n随着脚步的延伸，我的思绪也随之飘远
。去年冬天，和家人围坐在客厅的暖炉旁，炉火跳跃着，暖意不断渗入我的心田。那时候，我捧着一杯热茶，看着窗外的雪花在无
声地落着，内心充满了温暖与安宁。茶香氤氲，空气中弥漫着淡淡的柴火气息，那是家的味道，也是冬天的味道。\n\n我还想起小
时候第一次见到下雪的场景，那时我兴奋地跑出去，欢喜地踩着雪，像踩着棉花糖一样，无忧无虑。那一刻，整个世界都仿佛被点
亮了，连时光都慢了下来。现在回想起来，那个纯真的笑容早已封存在记忆的深处，却依然温暖着我的心灵。\n\n冬日的寒冷，让
我更加珍惜内心的温暖。它不是无情的，而是一种无声的沉淀。寒冷让人学会沉默，也让人更加敏锐地感知周围的美好。我开始在
寒冷中寻找属于自己的诗意，每一次呼吸、每一步脚印、每一片雪花的飘落，都像是自然写下的诗篇，值得细细品味。\n\n此刻，
我站在雪地里，听着风声，看着阳光，心里却涌动着从未有过的平静与满足。冬天不像夏日那样热烈，也不像秋天那般绚烂，但它
独有的冷冽与纯净，让我感受到生命的另一种节奏。它不是终点，而是另一种形式的开始，是静待春天的深沉，是内心在喧嚣之后
的归于平静。\n\n我开始喜欢这个季节，喜欢它带来的沉寂与沉思，喜欢它在寒冷中绽放的温柔。或许，真正的美并不总是热烈的
，有时它就藏在一片雪落无声的刹那，藏在心灵与自然相遇的时刻。'
}
 """


# %%
""" 今天天气格外冷，寒风呼啸着穿过街道，像是在诉说着冬天的无情。
清晨起来，窗外一片银装素裹，雪花静静地落在树梢上，仿佛给大地披上了一件洁白的棉衣。
空气中弥漫着清新的寒意，让人忍不住呼出一口白气。
虽然寒冷，但冬天也有它独特的魅力，那种宁静与纯净的感觉让人心旷神怡。
中午，我和家人围坐在温暖的火炉旁，吃着热腾腾的火锅，聊着过去的故事，温馨又惬意。
晚上，我趴在窗边看雪景，思绪随雪花飘散，想着未来的每一个冬天都会如此美好。
今天是个平凡却温暖的日子，让我更加珍惜寒冷中蕴藏的温情。 """
